import{affConfig as e}from"./aff.config.js";import{config as t}from"./config.js";const a=chrome.runtime.getURL("images/icon128.png"),s=chrome.runtime.getURL("images/not-phone.png"),o={Accept:"application/json","Content-Type":"application/json"},r=(e="")=>{chrome.action.setBadgeText({text:`${e}`}),chrome.action.setBadgeBackgroundColor({color:"#471ea3"})},n=async(e,t)=>await chrome.cookies.get({url:e,name:t}),c=async(e,t)=>await chrome.cookies.remove({url:e,name:t}),i=async(e,t)=>{const a=`1_${e}`;return await chrome.storage.local.set({[a]:t}),t},d=async e=>{const t=`1_${e}`;return(await chrome.storage.local.get([t]))[t]},h=async e=>{if(!e)return;const t=(await chrome.storage.local.get([e]))[e];return t&&t.uid?t:void 0},u=async(e,t)=>{if(!t||!e)return;const a={username:t,uid:e};return await chrome.storage.local.set({[t]:a}),a},m=()=>{chrome.storage.local.clear()},_=e=>new Promise(((t,a)=>{fetch(`https://mbasic.facebook.com/${e}/about`).then((e=>e.text())).then((a=>{let s=/&amp;id=([0-9]+)&amp;set=/m.exec(a),o=s?s[1]:void 0;o||(s=/owner_id=(\d+)/m.exec(a),o=s?s[1]:void 0),o&&u(o,e);let r=/<\s*body[^>]*>[\s\S]*<\s*\/\s*body\s*>/.exec(a),n=r?r[0]:void 0;t({uid:o,body:n})})).catch((()=>{a(void 0)}))})),E=e=>new Promise(((t,a)=>{fetch(`https://www.facebook.com/${e}/`).then((e=>e.text())).then((a=>{const s=/\userID":"(\d+)/m.exec(a),o=s?s[1]:void 0;o&&u(o,e);let r=/<\s*body[^>]*>[\s\S]*<\s*\/\s*body\s*>/.exec(a),n=r?r[0]:void 0;t({uid:o,body:n})})).catch((()=>{a(void 0)}))})),S=(e={})=>{const t=e.res.__meta__;return"success"===e.res.status?(t.availScans&&r(t.availScans),e.sendRes({status:e.res.status,code:e.res.code,data:e.res.data,meta:t})):e.sendRes({status:e.res.status,code:e.res.code,data:e.res.message,icon:s,meta:t})},f=async(e={})=>{if(e.err instanceof Response){const s=e.err.headers.get("content-type")?.includes("application/json"),o=s?await e.err.json():null;return 401===e.err.status?(c(t.WEBAPP_URL,"token"),e.sendRes({status:"error",data:'Vui lòng click vào biểu tượng "FBNumber" ở góc trên của trình duyệt để đăng nhập, hoặc đăng nhập bên dưới.',icon:a,code:o.code})):e.sendRes({status:"error",data:o.message,icon:a,code:o.code})}return e.sendRes({status:"error",data:"Vui lòng kiểm tra kết nối mạng của bạn và thử lại!",icon:s})};chrome.runtime.onMessage.addListener(((s,r,c)=>((async()=>{if("GET_REF_CONFIG"===s.action)return c(e.REF);if("GET_ALL_CONFIG"===s.action)return c({affConfig:e,config:t});if("GOOGLE_LOGIN"===s.action)return chrome.tabs.create({url:`${t.BASE_URL}/${t.LOGIN_PATH}?ref=${e.REF}`}),c(!0);if("S_US_GS"===s.action)return void fetch(`${t.BASE_URL}/${t.S_US_GS}`,{method:"GET",headers:o}).then((e=>e.ok?e.json():Promise.reject(e))).then((e=>{c({status:e.status,data:e.data})})).catch((()=>{c({status:"error"})}));if("S_US"===s.action)return void fetch(`${t.BASE_URL}/${t.S_US}`,{method:"POST",headers:o,body:s.data}).then((e=>e.ok?e.json():Promise.reject(e))).then((e=>{c({status:e.status,data:e.data})})).catch((()=>{c({status:"error"})}));if("S_ADS_GS"===s.action)return void fetch(`${t.BASE_URL}/${t.S_ADS_GS}`,{method:"GET",headers:o}).then((e=>e.ok?e.json():Promise.reject(e))).then((e=>{c({status:e.status,data:e.data})})).catch((()=>{c({status:"error"})}));if("S_ADS"===s.action)return void fetch(`${t.BASE_URL}/${t.S_ADS}`,{method:"POST",headers:o,body:s.data}).then((e=>e.ok?e.json():Promise.reject(e))).then((e=>{c({status:e.status,data:e.data})})).catch((()=>{c({status:"error"})}));if("U_PAGES"===s.action)return void fetch(`${t.BASE_URL}/${t.U_PAGES}`,{method:"POST",headers:o,body:s.data}).then((e=>e.ok?e.json():Promise.reject(e))).then((e=>{c({status:e.status,data:e.data})})).catch((()=>{c({status:"error"})}));if("OPEN_INCREASE_PAGE"===s.action)return chrome.tabs.create({url:`${t.WEBAPP_URL}/increases/follows`}),c(!0);if("COMMENT_OPEN"===s.action)return chrome.tabs.create({url:s.url}),c(!0);if("SHOW_SCAN_HISTORY"===s.action)return chrome.tabs.create({url:`${t.WEBAPP_URL}/scans`}),c(!0);if("SHOW_FIND_MORE_GUESTS"===s.action)return chrome.tabs.create({url:"https://tudongchat.com/"}),c(!0);if("GET_UID_BY_USERNAME"===s.action){const e=s.username;if(!e)return c({});const t=await h(e);if(t)return c({uid:t.uid});const{uid:a,body:o}=await E(e);return c({uid:a,body:o})}const r=await n(t.WEBAPP_URL,"token"),u=!(!r||!r.value);let m=await d("save_comment"),_=await d("accept_terms");if(m="1"===m?1:0,_="1"===_?1:0,"CHECK_LOGIN"===s.action)return c(u);if("CHECK_ACCEPT_TERMS"===s.action)return c(_);if(!u)return c({status:"error",data:'Vui lòng click vào biểu tượng "FBNumber" ở góc trên của trình duyệt để đăng nhập, hoặc đăng nhập bên dưới.',icon:a,code:"UNAUTHORIZED",email:"",location:""});if(o.Authorization=`Bearer ${r.value}`,"GET_PHONE"!==s.action)if("GET_BULK_PHONES"!==s.action)if("SEARCH_PHONE"!==s.action)if("SEARCH_BULK_PHONES"!==s.action)if("FIND_INFO_BY_UID_OR_PHONE"!==s.action){if("EXPORT_CSV"===s.action)return chrome.tabs.create({url:`${t.BASE_URL}/api/v1/scans/export-excel?token=${r.value}`}),c(!0);if("CLEAR_CACHE"===s.action)return chrome.storage.local.clear(),c(!0);if("BUY_NOW"===s.action)return chrome.runtime.openOptionsPage?chrome.runtime.openOptionsPage():window.open(chrome.runtime.getURL("options/options.html")),c(!0);if("USER_ME"!==s.action)if("ACCEPT_TERMS"!==s.action)if("PAYMENT_INFO"!==s.action)if("CHAT"!==s.action);else{const e=s.data;fetch(`${t.BASE_URL}/api/v1/chats/messages`,{method:"POST",headers:o,body:JSON.stringify(e)}).then((e=>e.ok?e.json():Promise.reject(e))).then((e=>{c({status:e.status,data:e.data,message:e.message})})).catch((()=>{c({status:"error",message:"Có lỗi xảy ra . Vui lòng thử lại sau!"})}))}else fetch(`${t.BASE_URL}/${t.GET_PAYMENT_INFO}`,{method:"GET",headers:o}).then((e=>e.ok?e.json():Promise.reject(e))).then((e=>{c({status:e.status,data:e.data})})).catch((()=>{c({status:"error"})}));else fetch(`${t.BASE_URL}/api/v1/user/accept-terms`,{method:"POST",headers:o}).then((e=>e.ok?e.json():Promise.reject(e))).then((e=>{const t=e.data.acceptTerms?"1":"0";i("accept_terms",t),S({sendRes:c,res:e})})).catch((e=>{f({sendRes:c,err:e})}));else fetch(`${t.BASE_URL}/api/v1/user/me`,{method:"GET",headers:o}).then((e=>e.ok?e.json():Promise.reject(e))).then((e=>{c({status:e.status,data:e.data})})).catch((()=>{c({status:"error"})}))}else{const e={searchUid:s.searchUid,searchPhone:s.searchPhone},a=`${t.BASE_URL}/api/v1/phone/find-info-by-uid-or-phone?`+new URLSearchParams(e);fetch(a,{method:"GET",headers:o}).then((e=>e.ok?e.json():Promise.reject(e))).then((e=>{c({status:e.status,data:e.data})})).catch((()=>{c({status:"error"})}))}else{const e=Object.assign({},s.data,{save_comment:m});fetch(`${t.BASE_URL}/${t.SEARCH_BULK_PHONE_PATH}`,{method:"POST",headers:o,body:JSON.stringify(e)}).then((e=>e.ok?e.json():Promise.reject(e))).then((e=>{S({sendRes:c,res:e})})).catch((e=>{f({sendRes:c,err:e})}))}else{const e=Object.assign({},s.data,{save_comment:m}),{uid:a,username:r}=s.data;if(!a){const t=await h(r);if(t)e.uid=t.uid;else{const t=await E(r);e.uid=t.uid,e.bText=t.body}}fetch(`${t.BASE_URL}/${t.SEARCH_PHONE_PATH}`,{method:"POST",headers:o,body:JSON.stringify(e)}).then((e=>e.ok?e.json():Promise.reject(e))).then((e=>{S({sendRes:c,res:e})})).catch((e=>{f({sendRes:c,err:e})}))}else fetch(`${t.BASE_URL}/${t.GET_BULK_PHONE_PATH}`,{method:"POST",headers:o,body:s.data}).then((e=>e.ok?e.json():Promise.reject(e))).then((e=>{S({sendRes:c,res:e})})).catch((e=>{f({sendRes:c,err:e})}));else{const e=Object.assign({},s.data,{save_comment:m}),a=`${t.BASE_URL}/${t.GET_PHONE_PATH}?`+new URLSearchParams(e);fetch(a,{method:"GET",headers:o}).then((e=>e.ok?e.json():Promise.reject(e))).then((e=>{S({sendRes:c,res:e})})).catch((e=>{f({sendRes:c,err:e})}))}})(),!0)));